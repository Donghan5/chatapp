events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Nginx가 80번 포트로 들어오는 요청을 받습니다.
    server {
        listen 80;
        server_name localhost;

        # 1. 프론트엔드 화면 (React/Vite 빌드 결과물)
        location / {
            root   /usr/share/nginx/html;
            index  index.html index.htm;
            try_files $uri /index.html;
        }

        # 2. 백엔드 API (NestJS로 토스)
        location /api/ {
            proxy_pass http://backend-service:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 3. 웹소켓 (NestJS Gateway로 토스)
        # Vite 개발 포트(5173)가 아니라, 실제 백엔드 포트(3000)로 보내야 합니다.
        location /socket.io/ {
            proxy_pass http://backend-service:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }
    }
}